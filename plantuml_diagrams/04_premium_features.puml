@startuml Premium Features Flow
title Premium Features Flow (Hint, Shuffle, Swap)

start

:User đang chơi game;
:User click Premium feature button;

partition "Premium Feature Selection" {
  :Xác định feature cần dùng;
  
  switch (Loại feature?)
  case (Hint)
    :User click "Gợi ý" button;
    
    partition "Hint Flow" {
      :Gọi API /api/premium/hint;
      :Check user đăng nhập;
      :Check premium status;
      
      if (User không phải Premium?) then (có)
        :Return error 403 "Chức năng premium. Vui lòng nâng cấp!";
        :Hiển thị toast notification;
        stop
      endif
      
      :Load game từ session;
      :Gọi game.get_hint();
      
      note right
        **get_hint() algorithm:**
        1. Test các hướng: left, right, up, down
        2. Simulate move theo từng hướng
        3. Check xem có grid thay đổi?
        4. Return hướng đầu tiên có move hợp lệ
      end note
      
      if (Có hint?) then (có)
        :Return direction (left/right/up/down);
        :Save game state;
        :Hiển thị animation gợi ý;
        :Highlight direction trên UI;
        :Flash toast "Gợi ý: [direction]";
      else (không)
        :Return error "Không có gợi ý";
        :Hiển thị toast warning;
      endif
    }
    
  case (Shuffle)
    :User click "Xáo trộn" button;
    
    partition "Shuffle Flow" {
      :Gọi API /api/premium/shuffle;
      :Check user đăng nhập;
      :Check premium status;
      
      if (User không phải Premium?) then (có)
        :Return error 403 "Chức năng premium. Vui lòng nâng cấp!";
        :Hiển thị toast notification;
        stop
      endif
      
      :Load game từ session;
      :Gọi game.shuffle();
      
      note right
        **shuffle() algorithm:**
        1. Collect tất cả tiles khác 0
        2. Random shuffle array
        3. Đặt lại vào grid theo thứ tự cũ
        4. Giữ nguyên score và moves
      end note
      
      :Return grid mới;
      :Save game state;
      :Render board với animation xáo trộn;
      :Flash toast "Đã xáo trộn!";
    }
    
  case (Swap)
    :User long-press 2 tiles để swap;
    
    partition "Swap Flow" {
      :Gọi API /api/premium/swap;
      :Check user đăng nhập;
      :Check premium status;
      
      if (User không phải Premium?) then (có)
        :Return error 403 "Chức năng premium. Vui lòng nâng cấp!";
        :Hiển thị toast notification;
        stop
      endif
      
      :Get row1, col1, row2, col2 từ request;
      
      :Validate parameters;
      if (Thiếu parameters?) then (có)
        :Return error 400 "Thiếu tham số";
        stop
      endif
      
      :Load game từ session;
      :Gọi game.swap_two_tiles(row1, col1, row2, col2);
      
      note right
        **swap_two_tiles() validation:**
        1. Check vị trí hợp lệ (0 <= row/col < size)
        2. Check không đổi chỗ ô với chính nó
        3. Check cả 2 ô đều khác 0
        4. Hoán đổi giá trị 2 ô
      end note
      
      if (Swap thành công?) then (có)
        :Return ok=True, grid mới, tile info;
        :Save game state;
        :Render board với animation swap;
        :Flash toast "Đã hoán đổi!";
      else (thất bại)
        :Return ok=False với message lỗi;
        :Hiển thị toast error;
      endif
    }
  endswitch
}

partition "Common Premium Checks" {
  note right
    **Premium checks được thực hiện:**
    1. User.check_premium_status()
    2. Check is_premium = True
    3. Check premium_expires_at > now
    4. Auto disable premium nếu hết hạn
  end note
}

:User tiếp tục chơi game;

stop

@enduml

