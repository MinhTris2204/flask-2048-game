@startuml Premium Payment Flow
title Premium Payment Flow (PayOS Integration)

start

:User đã đăng nhập;
:User truy cập /premium/manage;
:Check premium status;

if (Premium đã hết hạn?) then (có)
  :Update is_premium = False;
  :Commit database;
endif

:Hiển thị trang quản lý Premium;
:Lấy danh sách PremiumPlan active;
:Lấy lịch sử Order của user;

repeat
  if (User muốn mua gói Premium?) then (có)
    :User chọn gói Premium;
    :Redirect đến /payment/<plan_id>;
    
    partition "Payment Setup" {
      :Validate plan tồn tại và active;
      if (Plan không hợp lệ?) then (có)
        :Flash "Gói này không còn khả dụng";
        :Redirect về /premium/manage;
        stop
      endif
      
      :Hiển thị trang payment;
      :User chọn payment method;
      
      if (Thanh toán PayOS?) then (có)
        partition "PayOS Payment Flow" {
          :User click "Thanh toán PayOS";
          :Set session permanent;
          :Tạo Order mới;
          :Set user_id, plan_id, amount;
          :Set status = "pending";
          :Set transaction_id = UUID;
          :Add vào database;
          :Commit;
          
          :Tạo payment link PayOS;
          :Set description = "Premium {duration}d";
          :Gọi payos.create_payment_link();
          
          if (PayOS trả về lỗi?) then (có)
            :Flash thông báo lỗi;
            :Redirect về /premium/manage;
            stop
          endif
          
          :Lấy checkoutUrl từ PayOS;
          :Hiển thị trang payment_processing;
          :Auto redirect đến PayOS sau countdown;
        }
      else (Mock payment)
        :Tính expiration date;
        :Tạo Order với status = "completed";
        :Set transaction_id = UUID;
        :Add vào database;
        :Update user.is_premium = True;
        :Update user.premium_expires_at;
        :Commit;
        :Flash "Thanh toán thành công";
        :Redirect đến /game;
        stop
      endif
    }
    
    partition "PayOS Checkout" {
      :User thanh toán trên PayOS;
      
      if (User hủy thanh toán?) then (có)
        :PayOS redirect về /payos/cancel;
        :Update order.status = "cancelled";
        :Commit;
        :Hiển thị payment_error với "Bạn đã hủy thanh toán";
      else (thanh toán)
        :PayOS xử lý payment;
        
        if (Thanh toán thành công?) then (có)
          :PayOS redirect về /payos/return;
          :PayOS gọi /payos/webhook;
          
          partition "Webhook Handler" {
            :Verify webhook signature;
            if (Signature không hợp lệ?) then (có)
              :Return 400 error;
              stop
            endif
            
            :Parse webhook data;
            :Tìm order theo orderCode;
            :Validate amount;
            
            if (Order không tồn tại hoặc sai amount?) then (có)
              :Return 400/404 error;
              stop
            endif
            
            if (Order đã processed?) then (có)
              :Return success message;
              stop
            endif
            
            :Tính expiration date mới;
            :Update order.status = "completed";
            :Set completed_at;
            :Update transaction_id;
            :Update user.is_premium = True;
            :Update user.premium_expires_at;
            :Commit;
            :Return success;
          }
          
          partition "Return Handler" {
            :Verify payment code = "00";
            :Verify status = "PAID";
            :Tìm order;
            :Kiểm tra order.status = "pending";
            
            if (Order hợp lệ?) then (có)
              :Tính expiration date mới;
              :Update order.status = "completed";
              :Set completed_at;
              :Update user.is_premium = True;
              :Update user.premium_expires_at;
              :Commit;
              
              if (User chưa đăng nhập?) then (có)
                :Login user lại;
                :Set session permanent;
              endif
              
              :Hiển thị payment_success;
              :Hiển thị plan info, duration, amount;
              :User click "Về game";
              :Redirect đến /game;
              stop
            else (không hợp lệ)
              :Flash "Đơn hàng không hợp lệ";
              :Redirect đến /game;
              stop
            endif
          }
        else (thất bại)
          :PayOS redirect về /payos/return với error;
          :Update order.status = "failed";
          
          if (User chưa đăng nhập?) then (có)
            :Login user lại;
          endif
          
          :Hiển thị payment_error;
          :Show error message;
        endif
      endif
    }
  endif
  
  if (User muốn hủy Premium?) then (có)
    :Gọi API /api/premium/cancel;
    :Check user có Premium?;
    if (Không có Premium?) then (có)
      :Return error "Bạn chưa có Premium";
      stop
    endif
    
    :Tạo cancel_order để ghi log;
    :Set status = "cancelled";
    :Set amount = 0;
    :Add vào database;
    :Update user.is_premium = False;
    :Set user.premium_expires_at = None;
    :Commit;
    :Return success "Premium đã được hủy";
  endif
  
repeat while (User vẫn ở trang premium manage?)

stop

@enduml

