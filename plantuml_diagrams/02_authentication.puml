@startuml Authentication Flow
title Authentication Flow (Đăng ký, Đăng nhập, Google OAuth)

start

:User truy cập website;
:Redirect đến /login;

repeat
  :Hiển thị form đăng nhập;
  :User chọn phương thức;
  
  if (Đăng nhập Google?) then (có)
    partition "Google OAuth Flow" {
      :Kiểm tra config Google OAuth;
      if (Config chưa có?) then (có)
        :Hiển thị lỗi "Google Login chưa được cấu hình";
        stop
      endif
      
      :Tạo redirect URI;
      :Redirect đến Google OAuth;
      :Google hiển thị consent screen;
      :User chọn account;
      :Google redirect về /login/google/callback;
      
      :Lấy token từ Google;
      :Lấy user_info (sub, email, name);
      
      :Tìm user theo google_id;
      if (User đã tồn tại?) then (có)
        :Đăng nhập user;
        :Set session permanent;
        :Redirect đến /game;
        stop
      else (không tồn tại)
        :Tìm user theo email;
        if (Email đã tồn tại?) then (có)
          :Link Google với account hiện có;
          :Update google_id;
          :Update email nếu chưa có;
          :Commit database;
          :Đăng nhập user;
          :Flash thông báo "Đã liên kết với Google";
        else (chưa tồn tại)
          :Tạo username từ name/email;
          :Ensure username unique;
          :Tạo User mới;
          :Set google_id, email;
          :Add vào database;
          :Commit;
        endif
        :Đăng nhập user;
        :Set session permanent;
        :Redirect đến /game;
        stop
      endif
    }
  else (Đăng nhập thường)
    partition "Username/Password Login" {
      :User nhập username và password;
      :Submit form;
      
      :Validate input;
      if (Input rỗng?) then (có)
        :Flash "Vui lòng nhập đủ thông tin";
        :Stay on login page;
      else (không)
        :Tìm User theo username;
        if (User không tồn tại?) then (có)
          :Flash "Sai tên đăng nhập hoặc mật khẩu";
        else (tồn tại)
          :Check password;
          if (Password sai?) then (có)
            :Flash "Sai tên đăng nhập hoặc mật khẩu";
          else (đúng)
            :Login user với remember=True;
            :Set session permanent;
            :Redirect đến /game;
            stop
          endif
        endif
      endif
    }
  endif
  
  if (User muốn đăng ký?) then (có)
    :Redirect đến /register;
    partition "Registration Flow" {
      :Hiển thị form đăng ký;
      :User nhập username, password;
      :Submit form;
      
      :Validate input;
      if (Input rỗng?) then (có)
        :Flash "Vui lòng nhập đủ thông tin";
        :Stay on register page;
      else (không)
        :Kiểm tra username đã tồn tại;
        if (Username đã tồn tại?) then (có)
          :Flash "Tên đăng nhập đã tồn tại";
          :Stay on register page;
        else (chưa tồn tại)
          :Tạo User mới;
          :Set password hash;
          :Add vào database;
          :Commit;
          :Flash "Đăng ký thành công! Vui lòng đăng nhập";
          :Redirect đến /login;
        endif
      endif
    }
  endif
  
repeat while (Đăng nhập chưa thành công?) is (có)

if (Đăng nhập thành công?) then (có)
  :Redirect đến /game;
stop
else (chưa)
  :Stay on login page;
stop
endif

@enduml

