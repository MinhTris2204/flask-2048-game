{% extends "base.html" %}
{% block title %}Quáº£n lÃ½ Premium - 2048{% endblock %}
{% block description %}NÃ¢ng cáº¥p tÃ i khoáº£n Premium Ä‘á»ƒ má»Ÿ khÃ³a cÃ¡c tÃ­nh nÄƒng Ä‘áº·c biá»‡t: hoÃ n tÃ¡c, gá»£i Ã½ nÆ°á»›c Ä‘i, xÃ¡o trá»™n bÃ n cá», vÃ  Ä‘á»•i chá»— 2 Ã´. NÃ¢ng cáº¥p ngay Ä‘á»ƒ tráº£i nghiá»‡m game tá»‘t hÆ¡n!{% endblock %}
{% block content %}

<div class="premium-manage-page">
  <!-- Header -->
  <div class="premium-header">
    <h1 class="premium-title">
      <span class="premium-icon">â­</span>
      Quáº£n lÃ½ Premium
    </h1>
    <p class="premium-subtitle">Má»Ÿ khÃ³a táº¥t cáº£ tÃ­nh nÄƒng vá»›i Premium</p>
  </div>

  <!-- Premium Status Card -->
  <div class="premium-status-wrapper">
    <div class="premium-status-card {% if is_premium %}premium-active{% else %}premium-inactive{% endif %}">
      {% if is_premium %}
        <!-- Active Premium -->
        <div class="status-header">
          <div class="status-icon-wrapper">
            <span class="status-icon">â­</span>
            <div class="status-badge">Active</div>
          </div>
        </div>
        
        <div class="status-content">
          <h3 class="status-title">Premium Ä‘ang hoáº¡t Ä‘á»™ng</h3>
          <div class="status-info">
            <div class="info-item">
              <span class="info-label">Háº¿t háº¡n:</span>
              <span class="info-value">
                {% if premium_expires_at %}
                  {{ premium_expires_at.strftime('%d/%m/%Y %H:%M') }}
                {% else %}
                  KhÃ´ng giá»›i háº¡n
                {% endif %}
              </span>
            </div>
            {% if premium_expires_at %}
            <div class="progress-bar-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" id="premium-progress"></div>
              </div>
              <span class="progress-text" id="progress-text">0% thá»i gian cÃ²n láº¡i</span>
            </div>
            {% endif %}
          </div>
        </div>
        
        <div class="status-actions">
          <button onclick="cancelPremium()" class="btn-action-cancel">
            <span class="btn-icon">ğŸ—‘ï¸</span>
            <span>Há»§y Premium</span>
          </button>
          <a href="{{ url_for('game') }}" class="btn-action-play">
            <span class="btn-icon">ğŸ®</span>
            <span>ChÆ¡i ngay</span>
          </a>
        </div>
      {% else %}
        <!-- Inactive Premium -->
        <div class="status-header">
          <div class="status-icon-wrapper">
            <span class="status-icon inactive">ğŸ”’</span>
          </div>
        </div>
        
        <div class="status-content">
          <h3 class="status-title">ChÆ°a cÃ³ Premium</h3>
          <p class="status-description">NÃ¢ng cáº¥p Ä‘á»ƒ má»Ÿ khÃ³a táº¥t cáº£ tÃ­nh nÄƒng Ä‘á»™c quyá»n!</p>
        </div>
        
        <div class="feature-list">
          <div class="feature-item">
            <span class="feature-icon">ğŸ’¡</span>
            <span>Gá»£i Ã½ nÆ°á»›c Ä‘i thÃ´ng minh</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">ğŸ”€</span>
            <span>XÃ¡o trá»™n bÃ n cá»</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">ğŸ”„</span>
            <span>Äá»•i chá»— 2 Ã´ báº¥t ká»³</span>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Premium Plans -->
  <div class="premium-plans-wrapper">
    <h2 class="section-title">ğŸ“¦ GÃ³i Premium</h2>
    <div class="plans-grid">
      {% for plan in plans %}
      <div class="plan-card {% if plan.duration_days >= 365 %}plan-yearly{% endif %}">
        <div class="plan-header">
          <h3 class="plan-name">{{ plan.name }}</h3>
          {% if plan.duration_days >= 365 %}
          <div class="popular-badge">Phá»• biáº¿n</div>
          {% endif %}
        </div>
        
        <div class="plan-price-section">
          <div class="plan-price">
            <span class="price-amount">{{ "{:,.0f}".format(plan.price) }}</span>
            <span class="price-unit">VND</span>
          </div>
          <div class="plan-duration">
            {% if plan.duration_days >= 365 %}
              {{ (plan.duration_days / 365) | round(1) }} nÄƒm
            {% else %}
              {{ plan.duration_days }} ngÃ y
            {% endif %}
          </div>
        </div>
        
        <div class="plan-description">
          {{ plan.description if plan.description else 'HÆ°á»Ÿng trá»n váº¹n tÃ­nh nÄƒng Premium' }}
        </div>
        
        <a href="{{ url_for('payment', plan_id=plan.id) }}" class="plan-btn">
          {% if is_premium %}
            <span>ğŸ”„ Gia háº¡n</span>
          {% else %}
            <span>ğŸš€ Mua ngay</span>
          {% endif %}
        </a>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Order History -->
  {% if orders %}
  <div class="order-history-wrapper">
    <h2 class="section-title">ğŸ“‹ Lá»‹ch sá»­ giao dá»‹ch</h2>
    <div class="orders-list">
      {% for order in orders %}
      <div class="order-card">
        <div class="order-main">
          <div class="order-icon">
            {% if order.status == 'completed' %}âœ…
            {% elif order.status == 'pending' %}â³
            {% elif order.status == 'failed' %}âŒ
            {% elif order.status == 'cancelled' %}ğŸ—‘ï¸
            {% else %}ğŸ“„{% endif %}
          </div>
          
          <div class="order-details">
            <h4 class="order-name">
              {{ order.plan.name if order.plan else 'Premium' }}
            </h4>
            <p class="order-date">
              {{ order.created_at.strftime('%d/%m/%Y %H:%M') }}
            </p>
            {% if order.transaction_id %}
            <p class="order-transaction">
              <span class="transaction-label">MÃ£ giao dá»‹ch:</span>
              <span class="transaction-code">{{ order.transaction_id }}</span>
            </p>
            {% endif %}
          </div>
        </div>
        
        <div class="order-right">
          <div class="order-amount">
            {{ "{:,.0f}".format(order.amount) }} <span class="currency">VND</span>
          </div>
          <div class="order-status order-status-{{ order.status }}">
            {% if order.status == 'completed' %}HoÃ n thÃ nh
            {% elif order.status == 'pending' %}Äang xá»­ lÃ½
            {% elif order.status == 'failed' %}Tháº¥t báº¡i
            {% elif order.status == 'cancelled' %}ÄÃ£ há»§y
            {% else %}{{ order.status }}{% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Back Button -->
  <div class="premium-footer">
    <a href="{{ url_for('game') }}" class="back-link">
      <span>â†</span>
      <span>Quay láº¡i game</span>
    </a>
  </div>
</div>

<!-- Toast Notification Container -->
<div class="toast-container" id="toast-container"></div>

<script>
function showToast(message, type = 'info', duration = 3000) {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  
  const icons = {
    success: 'âœ…',
    error: 'âŒ',
    warning: 'âš ï¸',
    info: 'â„¹ï¸'
  };
  
  toast.innerHTML = `
    <span class="toast-icon">${icons[type] || 'â„¹ï¸'}</span>
    <span class="toast-content">${message}</span>
    <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
  `;
  
  const container = document.getElementById('toast-container');
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('fade-out');
    setTimeout(() => {
      toast.remove();
    }, 300);
  }, duration);
  
  return toast;
}

async function cancelPremium() {
  if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n há»§y Premium? Báº¡n sáº½ máº¥t quyá»n truy cáº­p vÃ o cÃ¡c tÃ­nh nÄƒng premium ngay láº­p tá»©c.")) {
    return;
  }
  
  try {
    const res = await fetch("/api/premium/cancel", { method: "POST" });
    const data = await res.json();
    
    if (data.ok) {
      showToast("Premium Ä‘Ã£ Ä‘Æ°á»£c há»§y thÃ nh cÃ´ng!", 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      showToast(data.message || "KhÃ´ng thá»ƒ há»§y Premium", 'error');
    }
  } catch (e) {
    console.error("Cancel premium error:", e);
    showToast("CÃ³ lá»—i xáº£y ra khi há»§y Premium", 'error');
  }
}

// Calculate and update progress bar
{% if premium_expires_at %}
(function() {
  const expiry = new Date("{{ premium_expires_at.isoformat() }}");
  const now = new Date();
  const created = new Date("{{ orders|selectattr('status', 'equalto', 'completed')|map(attribute='created_at')|list|last }}");
  const total = expiry - created;
  const elapsed = now - created;
  const progress = Math.max(0, Math.min(100, (total - elapsed) / total * 100));
  
  const progressFill = document.getElementById('premium-progress');
  const progressText = document.getElementById('progress-text');
  
  if (progressFill && progressText) {
    progressFill.style.width = progress + '%';
    progressText.textContent = Math.round(progress) + '% thá»i gian cÃ²n láº¡i';
  }
})();
{% endif %}
</script>
{% endblock %}
